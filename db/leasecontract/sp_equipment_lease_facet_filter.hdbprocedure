PROCEDURE "SAP_TM_TRP"."sap.tm.trp.db.leasecontract::sp_equipment_lease_facet_filter" (	
	IN FUZZYSEARCH_TEXT VARCHAR(500),
	IN RESOURCE_CATEGORY VARCHAR(50),
	IN FILTER_LEASE_PERIOD_BY NVARCHAR(20),
   	IN FROM_DATE TIMESTAMP,
	IN TO_DATE TIMESTAMP,
    IN LEASE_CONTRACT_TYPE_LIST_INPUT "sap.tm.trp.db.leasecontract::tt_str_list",
	OUT FILTERED_OUTPUT "sap.tm.trp.db.leasecontract::tt_equipment_lease_facet_filter_output")   
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER 
	DEFAULT SCHEMA "SAP_TM_TRP"
	READS SQL DATA AS

    LEASE_CONTRACT_TYPE_LIST_CNT INTEGER;
  
 BEGIN 

	DECLARE UNIT VARCHAR(3);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    SELECT ::SQL_ERROR_CODE, ::SQL_ERROR_MESSAGE FROM DUMMY;
 
LEASE_DATA=SELECT * FROM "_SYS_BIC"."sap.tm.trp.db.leasecontract/cv_lease_contract_visibility" 
(PLACEHOLDER."$$FILTER_LEASE_PERIOD_BY$$" => :FILTER_LEASE_PERIOD_BY, 
PLACEHOLDER."$$FROM_DATE$$" => :FROM_DATE,
PLACEHOLDER."$$TO_DATE$$" => :TO_DATE,
PLACEHOLDER."$$RESOURCE_CATEGORY$$" => :RESOURCE_CATEGORY)
        WHERE
        (LOWER(LEASE_CONTRACT_REFERENCE) LIKE '%'||LOWER(:FUZZYSEARCH_TEXT)||'%' OR
        LOWER(LESSOR) LIKE '%'||LOWER(:FUZZYSEARCH_TEXT)||'%' OR
        LOWER(LEASE_CONTRACT_TYPE) LIKE '%'||LOWER(:FUZZYSEARCH_TEXT)||'%')
        AND RESOURCE_CATEGORY = :RESOURCE_CATEGORY
    ;
    	
	SELECT COUNT(*) INTO LEASE_CONTRACT_TYPE_LIST_CNT FROM :LEASE_CONTRACT_TYPE_LIST_INPUT;
    
    IF :LEASE_CONTRACT_TYPE_LIST_CNT = 0
        THEN LEASE_CONTRACT_TYPE_LIST_INPUT = SELECT DISTINCT LEASE_CONTRACT_TYPE AS STR FROM :LEASE_DATA;
    END IF;


    FILTERED_OUTPUT = SELECT DISTINCT
        MASTER_TBL.LEASE_CONTRACT_TYPE
        FROM   :LEASE_DATA AS MASTER_TBL          
        INNER JOIN :LEASE_CONTRACT_TYPE_LIST_INPUT AS LEASE_CONTRACT_TYPE_TBL
            ON MASTER_TBL.LEASE_CONTRACT_TYPE = LEASE_CONTRACT_TYPE_TBL.STR
                
    ;

END
 