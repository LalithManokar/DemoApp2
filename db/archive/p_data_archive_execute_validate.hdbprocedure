PROCEDURE "SAP_TM_TRP"."sap.tm.trp.db.archive::p_data_archive_execute_validate" (
IN RULE_ID BIGINT,
OUT STATUS_CODE BIGINT,
OUT STATUS_MESSAGE NVARCHAR(500)
) 
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER 
	DEFAULT SCHEMA SAP_TM_TRP
	AS
BEGIN
	DECLARE TABLEID BIGINT;
	DECLARE DMTYPE TINYINT;
	DECLARE INPROCESS TINYINT;
	DECLARE COUNT INTEGER;
	DECLARE TO_UPDATE_COUNT INTEGER;
	DECLARE DMDESC VARCHAR(100);
	
	INPROCESS:=3;
	
	EXECUTION_DETAIL=SELECT * 
					 FROM "sap.tm.trp.db.archive::cv_archive_execution_detail"
					 WHERE TABLE_STATUS IN (5,3); --PARTIAL AND IN PROGRESS
					 
	SELECT IFNULL(TABLE_ID,0) INTO TABLEID FROM "sap.tm.trp.db.archive::t_archive_rule" WHERE ID=:RULE_ID;
	SELECT IFNULL(TYPE,0) INTO DMTYPE FROM "sap.tm.trp.db.archive::t_archive_rule" WHERE ID=:RULE_ID;
	
	IF :TABLEID=0
	THEN 
		
		INPROCESS_JOBS = SELECT * FROM :EXECUTION_DETAIL; 

		SELECT COUNT(1) INTO COUNT FROM :INPROCESS_JOBS;
		
		IF :COUNT>0
		THEN 
			STATUS_CODE:=0;
			STATUS_MESSAGE:='MSG_ARCHIEVE_FOUND_TABLE_USED';	
		ELSE
			STATUS_CODE:=1;
			STATUS_MESSAGE:='';
		END IF;			 
		  
	ELSE
		--INPROCESS_JOBS = SELECT * FROM :EXECUTION_DETAIL WHERE TABLE_ID=:TABLEID; 			 
					 
		SELECT COUNT(1) INTO COUNT FROM :INPROCESS_JOBS;		
		
		IF :COUNT>0
		THEN 
		
		--UPDATE THE STATUS OF EXECUTION INSTANCES WHICH HAVE INCONSISTENT IDS
	    --INCORRECT_STATUS_ROWS = SELECT * FROM :INPROCESS_JOBS WHERE TABLE_STATUS<>STATUS;
		 
		 INCORRECT_STATUS_ROWS = SELECT DISTINCT T1.ID,
								        T1.RULE_ID,
										T1.TABLE_ID,
										T1.EXECUTED_BY,
										IFNULL (T1.STATUS,T1.STATUS) AS STATUS,
										T1.HANDLE_ID, 
										T1.HANDLE_TIMESTAMP,
										T1.MESSAGE,
										T1.ERROR_CODE,
										T1.STATEMENT_STRING,
										T1.START_TIME,
										T1.END_TIME
								 FROM "sap.tm.trp.db.archive::t_archive_execution_detail" T1
								 LEFT JOIN :EXECUTION_DETAIL T2
								 ON (T1.ID = T2.ID AND T2.TABLE_STATUS<>T2.STATUS AND T1.TABLE_ID = :TABLEID);
			
		 SELECT COUNT(1) INTO TO_UPDATE_COUNT FROM :INCORRECT_STATUS_ROWS;
		 
		 IF :TO_UPDATE_COUNT>0 THEN
		   /*
           UPDATE "sap.tm.trp.db.archive::t_archive_execution_detail" T1
		   SET STATUS=T2.STATUS
		   FROM :INCORRECT_STATUS_ROWS T2
		   WHERE T1.ID=T2.ID;
		   */
		   
		   UPDATE "sap.tm.trp.db.archive::t_archive_execution_detail" T1
		   SET STATUS=(SELECT STATUS FROM :INCORRECT_STATUS_ROWS T2
		               WHERE T1.ID = T2.ID)
		   WHERE T1.TABLE_ID = :TABLEID;	
		 
		 END IF;
		 
		--END UPDATE 		
			
		SELECT TOP 1 CASE WHEN T2.TYPE = 1 
					  THEN 'Data Archive'
					  ELSE CASE WHEN T2.TYPE=2
					  THEN 'Data Unarchive'
					  ELSE 'Delete' END
					  END INTO DMDESC
		FROM :INPROCESS_JOBS T1
		INNER JOIN "sap.tm.trp.db.archive::t_archive_rule" T2
		ON T1.RULE_ID=T2.ID;
			
			STATUS_CODE:=0;
			STATUS_MESSAGE:='MSG_ARCHIEVE_JOB_EXECUTING';	
		ELSE
			STATUS_CODE:=1;
			STATUS_MESSAGE:='';
		END IF;			 
	END IF;
			 
END;
