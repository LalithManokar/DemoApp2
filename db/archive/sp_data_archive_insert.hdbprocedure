PROCEDURE "SAP_TM_TRP"."sap.tm.trp.db.archive::sp_data_archive_insert"
(IN RULE_ID BIGINT,
 IN TABLE_ID BIGINT,
 IN EXE_DETAIL_SEQ BIGINT,
 IN DATE_FROM TIMESTAMP,
 IN DATE_TO TIMESTAMP,
 IN DATE_COLUMN_NAME NVARCHAR(250),
 IN PARENT_FLAG TINYINT,
 IN ARCHIVE_FLAG TINYINT,
 IN IS_TM TINYINT,
 IN DATE_FROM_TM NVARCHAR(8),
 IN DATE_TO_TM NVARCHAR(8),
 IN TABLE_ROW_NUM BIGINT,
 IN MAX_TABLE_ROW_NUM BIGINT)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER 
DEFAULT SCHEMA "SAP_TM_TRP" AS  
	TABLE_NAME_HOT NVARCHAR(500);
	PARENT_TABLE_HOT NVARCHAR(500);
	PARENT_TABLE_WARM NVARCHAR(500);
	PARENT_REF_COL NVARCHAR(250);
	CHILD_REF_COL NVARCHAR(250);
	TABLE_NAME_WARM NVARCHAR(500);
	TABLE_EXIST BIGINT; 
	SCHEMA_NAME NVARCHAR(100);
	CONFIGURATION_TYPE NVARCHAR(100);
	ADAPTER_TYPE NVARCHAR(100);
	V_MIN BIGINT;
	V_MAX BIGINT;
	COLUMN_NAME NVARCHAR(250);
	COLUMN_LIST NVARCHAR(5000);
	SQL_FOR_INSERT NVARCHAR(5000);
	SQL_FOR_UPDATE_LOG NVARCHAR(5000);
	EXE_LOG_SEQ BIGINT;
	TEMP_TABLE_NAME_HOT NVARCHAR(500);
	TEMP_TABLE_NAME_WARM NVARCHAR(500);
	SDA_TABLE_NAME NVARCHAR(500);
	TEMP_PARENT_TABLE_HOT NVARCHAR(500);
	TEMP_PARENT_TABLE_WARM NVARCHAR(500);
	SQL_VIEW NVARCHAR(5000);
	VAL_COUNT BIGINT;
	V_MISSING_COL_COUNT BIGINT;
	DATASOURCE_NAME NVARCHAR(100);
	EXECUTION_TYPE TINYINT;
	SQL_FOR_CREATE_TEMP NVARCHAR(5000);
	SQL_FOR_ALTER_TEMP NVARCHAR(5000);
	SQL_FOR_INSERT_TEMP NVARCHAR(5000);
	SQL_FOR_DROP_TEMP NVARCHAR(5000);
	OBJECT_SCHEMA NVARCHAR(100);
	JOIN_COND NVARCHAR(5000);
	COND_FOR_COLUMN_EXIST CONDITION FOR SQL_ERROR_CODE 10001;
	NEWLY_ADDED_COLUMNS CONDITION FOR SQL_ERROR_CODE 10002;
BEGIN
	DECLARE EXIT HANDLER FOR COND_FOR_COLUMN_EXIST SIGNAL COND_FOR_COLUMN_EXIST SET MESSAGE_TEXT = 'MSG_ARCHIEVE_TRP_COLUMN_MISSING';   
	DECLARE EXIT HANDLER FOR NEWLY_ADDED_COLUMNS SIGNAL NEWLY_ADDED_COLUMNS SET MESSAGE_TEXT = 'MSG_ARCHIEVE_ADDED_COLUMN_MISSING';
	
	--Insert execution_log for INPROGRESS status & for INSERT operation
	IF :ARCHIVE_FLAG = 1 THEN 
		EXECUTION_TYPE := 1; --INSERT INTO WARM
	ELSE 
		EXECUTION_TYPE := 3; --INSERT INTO HOT
	END IF;
	SELECT "sap.tm.trp.db.archive::s_archive_execution_log".NEXTVAL INTO EXE_LOG_SEQ FROM DUMMY;
	INSERT INTO "sap.tm.trp.db.archive::t_archive_execution_log" 
	(ID,EXECUTION_ID,TABLE_ID,EXECUTION_TYPE,STATUS,RECORD_COUNT,MESSAGE,START_TIME)
	VALUES(:EXE_LOG_SEQ,:EXE_DETAIL_SEQ,:TABLE_ID,:EXECUTION_TYPE,3,0,'',CURRENT_UTCTIMESTAMP);

	IF :PARENT_FLAG = 0 THEN 
		--Extra Code Start
		SELECT IFNULL(TABLE_NAME,'') INTO PARENT_TABLE_HOT FROM "sap.tm.trp.db.archive::t_archive_metadata" 
		WHERE ID=(SELECT PARENT_ID FROM "sap.tm.trp.db.archive::t_archive_metadata" WHERE ID = :TABLE_ID);
		PARENT_TABLE_WARM := :PARENT_TABLE_HOT || '_warm';
		SELECT IFNULL(PARENT_REF_COL,'') INTO PARENT_REF_COL FROM "sap.tm.trp.db.archive::t_archive_metadata" WHERE ID = :TABLE_ID; 
		SELECT IFNULL(CHILD_REF_COL,'') INTO CHILD_REF_COL FROM "sap.tm.trp.db.archive::t_archive_metadata" WHERE ID = :TABLE_ID;
		CALL "sap.tm.trp.db.archive::sp_data_archive_join_preparation"(:PARENT_REF_COL,:CHILD_REF_COL,:JOIN_COND);
		IF :IS_TM = 0 THEN

			SELECT REPLACE(REPLACE(:PARENT_TABLE_HOT,'.','_'),'::','_') || '_hot_temp' INTO TEMP_PARENT_TABLE_HOT FROM DUMMY;
			SELECT REPLACE(REPLACE(:PARENT_TABLE_HOT,'.','_'),'::','_') || '_warm_temp' INTO TEMP_PARENT_TABLE_WARM FROM DUMMY;

		ELSE 
			TEMP_PARENT_TABLE_HOT:=:PARENT_TABLE_HOT || '_hot_temp';
			TEMP_PARENT_TABLE_WARM:=:PARENT_TABLE_HOT || '_warm_temp';
		END IF; 
		--Extra Code End
	END IF;

	--General Start
	SELECT IFNULL(TABLE_NAME,'') INTO TABLE_NAME_HOT FROM "sap.tm.trp.db.archive::t_archive_metadata" WHERE ID = :TABLE_ID;
	
	IF :IS_TM = 0 THEN
		TABLE_NAME_WARM := :TABLE_NAME_HOT ||'_warm';

		SELECT REPLACE(REPLACE(:TABLE_NAME_HOT,'.','_'),'::','_') || '_hot_temp' INTO TEMP_TABLE_NAME_HOT FROM DUMMY;
		SELECT REPLACE(REPLACE(:TABLE_NAME_HOT,'.','_'),'::','_') || '_warm_temp' INTO TEMP_TABLE_NAME_WARM FROM DUMMY;
		SDA_TABLE_NAME:=SUBSTR_AFTER(:TABLE_NAME_HOT,'::');
		SCHEMA_NAME := 'SAP_TM_TRP';
	ELSE 
		TABLE_NAME_WARM := :TABLE_NAME_HOT ||'_warm';
		TEMP_TABLE_NAME_HOT:=:TABLE_NAME_HOT||'_hot_temp';
		TEMP_TABLE_NAME_WARM:=:TABLE_NAME_HOT||'_warm_temp';
		SDA_TABLE_NAME:=:TABLE_NAME_HOT;
		--SCHEMA_NAME := 'SAPTM';
		SELECT IFNULL (MAX (OBJECT_SCHEMA),'') INTO OBJECT_SCHEMA FROM "SYS"."SYNONYMS" WHERE SCHEMA_NAME=:SCHEMA_NAME AND SYNONYM_NAME=:TABLE_NAME_HOT;
	END IF;
	--General End
	
	--Select column list preparation start
	SELECT IFNULL(VALUE,'') INTO CONFIGURATION_TYPE FROM "sap.tm.trp.db.archive::t_archive_configuration" WHERE KEY='CONFIGURATION_TYPE';
	IF :CONFIGURATION_TYPE = 'SDA' THEN 
		SELECT IFNULL(VALUE,'') INTO DATASOURCE_NAME FROM "sap.tm.trp.db.archive::t_archive_configuration" WHERE KEY='DATASOURCE_NAME';
	END IF;
	
	IF :CONFIGURATION_TYPE = 'SDA' THEN 
		IF :IS_TM = 0 THEN 
			HOT_TABLE_METADATA = SELECT COLUMN_NAME FROM "SYS"."TABLE_COLUMNS" 
								 WHERE SCHEMA_NAME=:SCHEMA_NAME AND TABLE_NAME=:TABLE_NAME_HOT;
		ELSE 
			HOT_TABLE_METADATA = SELECT COLUMN_NAME FROM "SYS"."TABLE_COLUMNS" 
								 WHERE SCHEMA_NAME=(SELECT DISTINCT OBJECT_SCHEMA FROM "SYS"."SYNONYMS" 
								 					WHERE SCHEMA_NAME=:SCHEMA_NAME AND SYNONYM_NAME=:TABLE_NAME_HOT) 
								 AND TABLE_NAME=:TABLE_NAME_HOT;
		END IF;
		
		SELECT IFNULL(VALUE,0) INTO ADAPTER_TYPE FROM "sap.tm.trp.db.archive::t_archive_configuration" WHERE KEY='ADAPTER_TYPE';
		SELECT IFNULL(SQL_VIEW,'') INTO SQL_VIEW FROM "sap.tm.trp.db.archive::t_data_archive_adapters" WHERE ID=:ADAPTER_TYPE;
		SQL_VIEW := REPLACE(:SQL_VIEW,'<RULE_ID>',:RULE_ID||' AS RULE_ID,'||:EXE_DETAIL_SEQ||' AS EXECUTION_ID');
		SQL_VIEW := REPLACE(:SQL_VIEW,':SDA_TABLE_NAME',:SDA_TABLE_NAME);
		SQL_VIEW := REPLACE(:SQL_VIEW,'<RDS_NAME>',LOWER(:DATASOURCE_NAME));
		SQL_VIEW := 'INSERT INTO "sap.tm.trp.db.archive::global_tmp_archive_remote_source_columns" (RULE_ID,EXECUTION_ID,SCHEMA_NAME,TABLE_NAME,COLUMN_NAME) '||:SQL_VIEW;
		EXECUTE IMMEDIATE :SQL_VIEW;
		WARM_TABLE_METADATA = SELECT COLUMN_NAME FROM "sap.tm.trp.db.archive::global_tmp_archive_remote_source_columns" WHERE LOWER(TABLE_NAME)=LOWER(:SDA_TABLE_NAME) AND RULE_ID=:RULE_ID AND EXECUTION_ID=:EXE_DETAIL_SEQ;
		TRUNCATE TABLE "SAP_TM_TRP"."sap.tm.trp.db.archive::global_tmp_archive_remote_source_columns";
		
		IF :PARENT_FLAG = 1 THEN 
			SELECT COUNT(1) INTO VAL_COUNT FROM :WARM_TABLE_METADATA WHERE COLUMN_NAME IN ('TRP_RULE_ID','TRP_EXECUTION_ID');
			IF :VAL_COUNT!=2 THEN 
				SIGNAL COND_FOR_COLUMN_EXIST;
			END IF; 
		ELSE 
			SELECT COUNT(1) INTO VAL_COUNT FROM :WARM_TABLE_METADATA WHERE COLUMN_NAME IN ('TRP_RULE_ID','TRP_EXECUTION_ID',:DATE_COLUMN_NAME);
			IF :VAL_COUNT!=3 THEN 
				SIGNAL COND_FOR_COLUMN_EXIST;
			END IF; 
		END IF;
		
		EXLCUSIVE_COLUMN_LIST = SELECT COLUMN_NAME FROM :HOT_TABLE_METADATA EXCEPT 
								   SELECT COLUMN_NAME FROM :WARM_TABLE_METADATA;
								   
		SELECT COUNT(1) INTO V_MISSING_COL_COUNT FROM :EXLCUSIVE_COLUMN_LIST;
		IF :V_MISSING_COL_COUNT > 0 THEN 
			SIGNAL NEWLY_ADDED_COLUMNS;
		END IF;
	
		SELECT_COLUMN_LIST = SELECT COLUMN_NAME,1 AS DUMMY FROM :HOT_TABLE_METADATA INTERSECT 
								   SELECT COLUMN_NAME,1 AS DUMMY FROM :WARM_TABLE_METADATA;
		SELECT_COLUMN_LIST_TABLE = 	 SELECT COLUMN_NAME, ROW_NUMBER() over (partition by DUMMY order by DUMMY) as ROW_NUM 
									 FROM :SELECT_COLUMN_LIST;

	ELSE IF :CONFIGURATION_TYPE = 'DT' THEN 
		IF :IS_TM = 0 THEN 
			SELECT_COLUMN_LIST_TABLE = SELECT COLUMN_NAME, ROW_NUMBER() over (partition by SCHEMA_NAME order by SCHEMA_NAME) as ROW_NUM 
									   FROM "SYS"."TABLE_COLUMNS" 
									   WHERE SCHEMA_NAME=:SCHEMA_NAME AND TABLE_NAME=:TABLE_NAME_HOT;
		ELSE 
			SELECT_COLUMN_LIST_TABLE = SELECT COLUMN_NAME, ROW_NUMBER() over (partition by SCHEMA_NAME order by SCHEMA_NAME) as ROW_NUM 
									   FROM "SYS"."TABLE_COLUMNS" 
									   WHERE SCHEMA_NAME=(SELECT DISTINCT OBJECT_SCHEMA FROM "SYS"."SYNONYMS" 
									 					WHERE SCHEMA_NAME=:SCHEMA_NAME AND SYNONYM_NAME=:TABLE_NAME_HOT) 
									   AND TABLE_NAME=:TABLE_NAME_HOT;
		END IF;
	END IF;
	END IF;
	
	SELECT MIN(ROW_NUM) INTO V_MIN FROM :SELECT_COLUMN_LIST_TABLE;
	SELECT MAX(ROW_NUM) INTO V_MAX FROM :SELECT_COLUMN_LIST_TABLE;
	WHILE :V_MIN <= :V_MAX DO 
		SELECT IFNULL(COLUMN_NAME,'') INTO COLUMN_NAME FROM :SELECT_COLUMN_LIST_TABLE WHERE ROW_NUM=:V_MIN;
		IF V_MIN = 1 THEN 
			IF :PARENT_FLAG = 1 THEN 
				COLUMN_LIST := :COLUMN_NAME;
			ELSE 
				COLUMN_LIST := 'C.'||:COLUMN_NAME;
			END IF;
		ELSE 
			IF :PARENT_FLAG = 1 THEN 
				COLUMN_LIST := :COLUMN_LIST||','||:COLUMN_NAME;
			ELSE 
				COLUMN_LIST := :COLUMN_LIST||',C.'||:COLUMN_NAME;
			END IF;
		END IF;
		V_MIN := :V_MIN+1;
	END WHILE;
	--Select column list preparation end
	
	--Core Logic Starts Here
	IF :ARCHIVE_FLAG = 1 THEN 
		IF :IS_TM = 0 THEN  
			IF :PARENT_FLAG = 1 THEN 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_HOT||'" SELECT * FROM "'||:SCHEMA_NAME||'"."'||:TABLE_NAME_HOT||'" WHERE TO_TIMESTAMP('||escape_single_quotes(:DATE_COLUMN_NAME)||') BETWEEN '||''''||:DATE_FROM||''''||' AND '||''''||:DATE_TO||'''';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				SQL_FOR_INSERT :='INSERT INTO "'||:TABLE_NAME_WARM||'"('||:COLUMN_LIST||',TRP_RULE_ID,TRP_EXECUTION_ID) SELECT '||:COLUMN_LIST||','||:RULE_ID||' AS TRP_RULE_ID,'||:EXE_DETAIL_SEQ||' AS TRP_EXECUTION_ID FROM "'||:TEMP_TABLE_NAME_HOT||'"';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_HOT||'") WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			ELSE 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_HOT||'"('||REPLACE(:COLUMN_LIST,'C.','')||','||escape_single_quotes(:DATE_COLUMN_NAME)||') SELECT DISTINCT '||:COLUMN_LIST||',P.'||escape_single_quotes(:DATE_COLUMN_NAME)||' FROM "'||:TABLE_NAME_HOT||'" C INNER JOIN "'||:TEMP_PARENT_TABLE_HOT||'" P ON '||:JOIN_COND;
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				IF :TABLE_ROW_NUM = :MAX_TABLE_ROW_NUM THEN 
					SQL_FOR_INSERT :='INSERT INTO "'||:TABLE_NAME_WARM||'"('||REPLACE(:COLUMN_LIST,'C.','')||',TRP_RULE_ID,TRP_EXECUTION_ID,'||escape_single_quotes(:DATE_COLUMN_NAME)||') SELECT DISTINCT '||REPLACE(:COLUMN_LIST,'C.','')||','||:RULE_ID||' AS TRP_RULE_ID,'||:EXE_DETAIL_SEQ||' AS TRP_EXECUTION_ID,TO_TIMESTAMP('||escape_single_quotes(:DATE_COLUMN_NAME)||') FROM "'||:TEMP_TABLE_NAME_HOT||'"';
					EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				END IF;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_HOT||'" ) WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			END IF;
		--:IS_TM=1
		ELSE 
			IF :PARENT_FLAG = 1 THEN 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_HOT||'" SELECT T.* FROM "'||:SCHEMA_NAME||'"."'||:TABLE_NAME_HOT||'" T INNER JOIN "sap.tm.trp.db.semantic.common::v_client_code" CC ON T.MANDT =CC.MANDT WHERE TO_TIMESTAMP(T.'||escape_single_quotes(:DATE_COLUMN_NAME)||') BETWEEN '||''''||:DATE_FROM||''''||' AND '||''''||:DATE_TO||'''';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				SQL_FOR_INSERT :='INSERT INTO "'||:TABLE_NAME_WARM||'"('||:COLUMN_LIST||',TRP_RULE_ID,TRP_EXECUTION_ID) SELECT '||:COLUMN_LIST||','||:RULE_ID||' AS TRP_RULE_ID,'||:EXE_DETAIL_SEQ||' AS TRP_EXECUTION_ID FROM "'||:TEMP_TABLE_NAME_HOT||'"';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_HOT||'" ) WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			ELSE 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_HOT||'"('||REPLACE(:COLUMN_LIST,'C.','')||','||escape_single_quotes(:DATE_COLUMN_NAME)||') SELECT DISTINCT '||:COLUMN_LIST||',P.'||escape_single_quotes(:DATE_COLUMN_NAME)||' FROM "'||:TABLE_NAME_HOT||'" C INNER JOIN "'||:TEMP_PARENT_TABLE_HOT||'" P ON '||:JOIN_COND||' INNER JOIN "sap.tm.trp.db.semantic.common::v_client_code" CC ON P.MANDT =CC.MANDT AND C.MANDT =CC.MANDT';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				IF :TABLE_ROW_NUM = :MAX_TABLE_ROW_NUM THEN 
					SQL_FOR_INSERT :='INSERT INTO "'||:TABLE_NAME_WARM||'"('||REPLACE(:COLUMN_LIST,'C.','')||',TRP_RULE_ID,TRP_EXECUTION_ID,'||escape_single_quotes(:DATE_COLUMN_NAME)||') SELECT DISTINCT '||REPLACE(:COLUMN_LIST,'C.','')||','||:RULE_ID||' AS TRP_RULE_ID,'||:EXE_DETAIL_SEQ||' AS TRP_EXECUTION_ID,TO_TIMESTAMP('||escape_single_quotes(:DATE_COLUMN_NAME)||') FROM "'||:TEMP_TABLE_NAME_HOT||'"';
					EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				END IF;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_HOT||'"  ) WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			END IF;
		END IF;
	--:ARCHIVE_FLAG = 0
	ELSE 
			IF :IS_TM = 0 THEN  
			IF :PARENT_FLAG = 1 THEN 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_WARM||'" SELECT * FROM "'||:TABLE_NAME_WARM||'"  WHERE TO_TIMESTAMP('||escape_single_quotes(:DATE_COLUMN_NAME)||') BETWEEN '||''''||:DATE_FROM||''''||' AND '||''''||:DATE_TO||'''';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				SQL_FOR_INSERT :='INSERT INTO "'||:SCHEMA_NAME||'"."'||:TABLE_NAME_HOT||'"('||:COLUMN_LIST||') SELECT DISTINCT '||:COLUMN_LIST||' FROM "'||:TEMP_TABLE_NAME_WARM||'"';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_WARM||'" ) WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			ELSE 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_WARM||'"('||REPLACE(:COLUMN_LIST,'C.','')||',TRP_RULE_ID,TRP_EXECUTION_ID,'||escape_single_quotes(:DATE_COLUMN_NAME)||') SELECT DISTINCT '||:COLUMN_LIST||',C.TRP_RULE_ID,C.TRP_EXECUTION_ID,C.'||escape_single_quotes(:DATE_COLUMN_NAME)||' FROM "'||:TABLE_NAME_WARM||'" C INNER JOIN "'||:TEMP_PARENT_TABLE_WARM||'" P ON '||:JOIN_COND;
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				IF :TABLE_ROW_NUM = :MAX_TABLE_ROW_NUM THEN 
					SQL_FOR_INSERT :='INSERT INTO "'||:SCHEMA_NAME||'"."'||:TABLE_NAME_HOT||'"('||REPLACE(:COLUMN_LIST,'C.','')||') SELECT DISTINCT '||REPLACE(:COLUMN_LIST,'C.','')||' FROM "'||:TEMP_TABLE_NAME_WARM||'"';
					EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				END IF;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_WARM||'") WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			END IF;
		--:IS_TM=1
		ELSE 
			IF :PARENT_FLAG = 1 THEN 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_WARM||'" SELECT T.* FROM "'||:TABLE_NAME_WARM||'" T INNER JOIN "sap.tm.trp.db.semantic.common::v_client_code" CC ON T.MANDT =CC.MANDT WHERE SUBSTR(T.'||escape_single_quotes(:DATE_COLUMN_NAME)||',1,8) BETWEEN '||''''||escape_single_quotes(:DATE_FROM_TM)||''''||' AND '||''''||escape_single_quotes(:DATE_TO_TM)||'''';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				SQL_FOR_INSERT :='INSERT INTO "'||:SCHEMA_NAME||'"."'||:TABLE_NAME_HOT||'"('||:COLUMN_LIST||') SELECT '||:COLUMN_LIST||' FROM "'||:TEMP_TABLE_NAME_WARM||'"';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_WARM||'" ) WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			ELSE 
				SQL_FOR_INSERT_TEMP := 'INSERT INTO "'||:TEMP_TABLE_NAME_WARM||'"('||REPLACE(:COLUMN_LIST,'C.','')||',TRP_RULE_ID,TRP_EXECUTION_ID,'||escape_single_quotes(:DATE_COLUMN_NAME)||') SELECT DISTINCT '||:COLUMN_LIST||',C.TRP_RULE_ID,C.TRP_EXECUTION_ID,C.'||escape_single_quotes(:DATE_COLUMN_NAME)||' FROM "'||:TABLE_NAME_WARM||'" C INNER JOIN "'||:TEMP_PARENT_TABLE_WARM||'" P ON '||:JOIN_COND||' INNER JOIN "sap.tm.trp.db.semantic.common::v_client_code" CC ON P.MANDT =CC.MANDT AND C.MANDT =CC.MANDT';
				EXECUTE IMMEDIATE :SQL_FOR_INSERT_TEMP ;
				IF :TABLE_ROW_NUM = :MAX_TABLE_ROW_NUM THEN 
					SQL_FOR_INSERT :='INSERT INTO "'||:SCHEMA_NAME||'"."'||:TABLE_NAME_HOT||'"('||REPLACE(:COLUMN_LIST,'C.','')||') SELECT DISTINCT '||REPLACE(:COLUMN_LIST,'C.','')||' FROM "'||:TEMP_TABLE_NAME_WARM||'"' ;
					EXECUTE IMMEDIATE :SQL_FOR_INSERT;
				END IF;
				--Update execution_log for SUCESS status & for INSERT operation
				SQL_FOR_UPDATE_LOG :='UPDATE "sap.tm.trp.db.archive::t_archive_execution_log" SET STATUS=1,END_TIME=CURRENT_UTCTIMESTAMP, RECORD_COUNT = (SELECT COUNT(1) FROM "'||:TEMP_TABLE_NAME_WARM||'") WHERE ID = '||:EXE_LOG_SEQ;
				EXECUTE IMMEDIATE :SQL_FOR_UPDATE_LOG;
			END IF;
		END IF;
	END IF;
	--Core Logic Ends Here
END;