PROCEDURE "SAP_TM_TRP"."sap.tm.trp.db.systemmanagement.location::p_getlocations_of_zone"(
 IN LOCATION_IDS "sap.tm.trp.db.systemmanagement::tt_division_id",
 IN STATE_CODES  "sap.tm.trp.db.systemmanagement::tt_division_admingis_codes", 
 IN POSTAL_CODES "sap.tm.trp.db.systemmanagement::tt_division_postal_codes",
OUT OUT_LOCATION_LIST "sap.tm.trp.db.systemmanagement.location::tt_location_info")
    LANGUAGE SQLSCRIPT
    SQL SECURITY INVOKER 
    DEFAULT SCHEMA "SAP_TM_TRP"
    AS
BEGIN
   
    LOCATION_LIST_FOR_LOCATIONS = SELECT T2.ID AS LOCATION_ID,T2.NAME,T2.DESC,T2.COUNTRY_CODE,T2.COUNTRY_NAME,
        T2.REGION_CODE AS STATE_CODE,T2.STATE_NAME,T2.CITY_ID,T2.CITY_NAME,T2.XPOS,T2.YPOS,T2.POSTAL_CODE,T2.RANK
    FROM :LOCATION_IDS T1
    INNER JOIN "sap.tm.trp.db.systemmanagement.location::v_location_ui" T2 ON (T1.ID = T2.ID);
  
    LOCATION_LIST_FOR_STATE_CODES =  
      SELECT LOCATION_ID,NAME,DESC,COUNTRY_CODE,COUNTRY_NAME,STATE_CODE,STATE_NAME,CITY_ID,CITY_NAME,XPOS,YPOS,POSTAL_CODE,RANK
	  FROM
	  (
	    SELECT T2.ID AS LOCATION_ID,T2.NAME,T2.DESC,T2.COUNTRY_CODE,T2.COUNTRY_NAME,
        T2.REGION_CODE AS STATE_CODE,T2.STATE_NAME,T2.CITY_ID,T2.CITY_NAME,T2.XPOS,T2.YPOS,T2.POSTAL_CODE,T2.RANK
	    FROM (SELECT COUNTRY_CODE, STATE_CODE FROM :STATE_CODES WHERE COUNTRY_CODE <> '' AND STATE_CODE <> '') T1 
	    INNER JOIN "sap.tm.trp.db.systemmanagement.location::v_location_ui" T2 
	    ON T1.COUNTRY_CODE = T2.COUNTRY_CODE AND T1.STATE_CODE = T2.REGION_CODE
	   UNION ALL   
	   SELECT T2.ID AS LOCATION_ID,T2.NAME,T2.DESC,T2.COUNTRY_CODE,T2.COUNTRY_NAME,
        T2.REGION_CODE AS STATE_CODE,T2.STATE_NAME,T2.CITY_ID,T2.CITY_NAME,T2.XPOS,T2.YPOS,T2.POSTAL_CODE,T2.RANK
	    FROM (SELECT COUNTRY_CODE, STATE_CODE  FROM :STATE_CODES WHERE COUNTRY_CODE <> '' AND STATE_CODE = '') T1 
	    INNER JOIN "sap.tm.trp.db.systemmanagement.location::v_location_ui" T2 
	    ON T1.COUNTRY_CODE = T2.COUNTRY_CODE
	   );
	   
	  LOCATION_LIST_FOR_POSTAL_CODES = 
	  SELECT  T2.ID AS LOCATION_ID,T2.NAME,T2.DESC,T2.COUNTRY_CODE,T2.COUNTRY_NAME,
        T2.REGION_CODE AS STATE_CODE,T2.STATE_NAME,T2.CITY_ID,T2.CITY_NAME,T2.XPOS,T2.YPOS,T2.POSTAL_CODE,T2.RANK
      FROM :POSTAL_CODES T1 
	  INNER JOIN "sap.tm.trp.db.systemmanagement.location::v_location_ui" T2 
	  ON (T1.COUNTRY_CODE = T2.COUNTRY_CODE AND T2.POSTAL_CODE BETWEEN T1.POSTAL_CODE_FROM  AND T1.POSTAL_CODE_TO);
	 
      OUT_LOCATION_LIST =
      SELECT DISTINCT LOCATION_ID,NAME,DESC,COUNTRY_CODE,COUNTRY_NAME,STATE_CODE,STATE_NAME,CITY_ID,CITY_NAME,XPOS,YPOS,POSTAL_CODE,RANK 
      FROM
      (
	      SELECT LOCATION_ID,NAME,DESC,COUNTRY_CODE,COUNTRY_NAME,STATE_CODE,STATE_NAME,CITY_ID,CITY_NAME,XPOS,YPOS,POSTAL_CODE,RANK
	      FROM :LOCATION_LIST_FOR_LOCATIONS
	      UNION ALL 
	      SELECT LOCATION_ID,NAME,DESC,COUNTRY_CODE,COUNTRY_NAME,STATE_CODE,STATE_NAME,CITY_ID,CITY_NAME,XPOS,YPOS,POSTAL_CODE,RANK
	      FROM :LOCATION_LIST_FOR_STATE_CODES
	      UNION ALL 
	      SELECT LOCATION_ID,NAME,DESC,COUNTRY_CODE,COUNTRY_NAME,STATE_CODE,STATE_NAME,CITY_ID,CITY_NAME,XPOS,YPOS,POSTAL_CODE,RANK
	      FROM :LOCATION_LIST_FOR_POSTAL_CODES
      );

END;