PROCEDURE "SAP_TM_TRP"."sap.tm.trp.db.supplydemand.instant.datasource::p_resource" (
	OUT OUTPUT "SAP_TM_TRP"."sap.tm.trp.db.supplydemand.instant::t_basic_node"
) 
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER 
DEFAULT SCHEMA SAP_TM_TRP
AS
BEGIN

DECLARE MAX_UPDATE_TIME TIMESTAMP;
SELECT MAX(UPDATE_TIME) INTO MAX_UPDATE_TIME FROM "sap.tm.trp.db.supplydemand.instant::t_basic_node" WHERE SOURCE_TYPE = 'RESOURCE';

MASTER_DATA=SELECT
	RESOURCE_ID, 
	CASE STOCK_STATUS_CODE
	WHEN '' THEN 'STOCK_EMPTY_AND_AVAILABLE'
	WHEN 'DMG' THEN 'STOCK_DAMAGED'
	WHEN 'OOF' THEN 'STOCK_OUT_OF_FLEET'
	WHEN 'RSV' THEN 'STOCK_RESERVED'
	WHEN 'SBL' THEN 'STOCK_SUBLEASED'
	WHEN 'OTR' THEN 'STOCK_OTHERS'
	END AS NODE,
	LOCATION_ID,
	RESOURCE_CATEGORY,
	RESOURCE_TYPE,
	--greatest of LAST_STATUS_TIME,CHANGEDATE saved in UPDATE_TIME
	CASE WHEN TO_TIMESTAMP(LAST_STATUS_TIME) > TO_TIMESTAMP(CHANGEDATE) THEN
	    TO_TIMESTAMP(LAST_STATUS_TIME) 
	    ELSE
	    TO_TIMESTAMP(CHANGEDATE) 
	END AS CHANGEDATE, 
	TO_TIMESTAMP(LAST_STATUS_TIME) AS LAST_STATUS_TIME
FROM "sap.tm.trp.db.semantic.resource::v_stock_resource_last_status";



OUTPUT=
SELECT '' AS CLIENT,
	'0000' AS COMPANY_CODE,
	RESOURCE_ID AS SOURCE_KEY, 
	'RESOURCE' AS SOURCE_TYPE,
	NODE,
	LOCATION_ID,
	RESOURCE_CATEGORY AS RESOURCE_GROUP,
	RESOURCE_TYPE,
	'STOCK' AS OUTPUT_KEY,
	1 AS QUANTITY,
	CHANGEDATE AS UPDATE_TIME, 
	LAST_STATUS_TIME AS OCCURRED_TIME, 
	'' AS DELETE_FLAG
FROM(
	SELECT T1.* FROM :MASTER_DATA T1
		WHERE (:MAX_UPDATE_TIME IS NULL OR LAST_STATUS_TIME > :MAX_UPDATE_TIME OR CHANGEDATE>:MAX_UPDATE_TIME)
	UNION
	--mismacthed records 
	SELECT T1.* FROM :MASTER_DATA T1
		INNER JOIN "sap.tm.trp.db.supplydemand.instant::t_basic_node" harmize_tab
		ON harmize_tab.SOURCE_KEY=T1.RESOURCE_ID AND 
		(harmize_tab.UPDATE_TIME < T1.LAST_STATUS_TIME OR harmize_tab.UPDATE_TIME < T1.CHANGEDATE)
		WHERE (T1.LAST_STATUS_TIME < :MAX_UPDATE_TIME OR T1.CHANGEDATE < :MAX_UPDATE_TIME)
		AND harmize_tab.DELETE_FLAG <> 'X'
		AND harmize_tab.SOURCE_TYPE='RESOURCE'
	UNION
	--missed records
	SELECT T1.* FROM :MASTER_DATA T1
	WHERE (T1.LAST_STATUS_TIME < :MAX_UPDATE_TIME OR T1.CHANGEDATE < :MAX_UPDATE_TIME)
	AND NOT EXISTS (SELECT 1 FROM "sap.tm.trp.db.supplydemand.instant::t_basic_node" harmize_tab
	WHERE harmize_tab.SOURCE_KEY=T1.RESOURCE_ID 
	AND harmize_tab.SOURCE_TYPE='RESOURCE'));

END;